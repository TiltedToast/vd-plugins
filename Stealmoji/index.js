(function(S,r,h,m,a,p,g,x,P){"use strict";const L=a.findByProps("convertSurrogateToName"),d=a.findByProps("hideActionSheet"),C=a.findByProps("openMediaModal"),D=a.findByProps("uploadEmoji"),I=a.findByProps("ActionSheet")?.ActionSheet??a.find(function(t){return t.render?.name==="ActionSheet"}),{ActionSheetTitleHeader:F,ActionSheetCloseButton:_}=a.findByProps("ActionSheetTitleHeader"),{BottomSheetFlatList:G}=a.findByProps("BottomSheetScrollView"),z=a.findByStoreName("EmojiStore"),k=a.findByStoreName("GuildStore"),U=a.findByStoreName("PermissionStore"),{default:O,GuildIconSizes:H}=a.findByProps("GuildIconSizes"),{downloadMediaAsset:V}=a.findByProps("downloadMediaAsset");function X(t){return new Promise(function(e,n){r.ReactNative.Image.getSize(t,function(i,o){e([i,o])},n)})}async function q(t){const[e,n]=await X(t),{width:i,height:o}=r.ReactNative.Dimensions.get("window");d.hideActionSheet(),C.openMediaModal({initialSources:[{uri:t,sourceURI:t,width:e,height:n}],initialIndex:0,originLayout:{width:128,height:128,x:i/2-64,y:o-64,resizeMode:"fill"}})}function N(t,e){fetch(t).then(function(n){n.blob().then(function(i){const o=new FileReader;o.readAsDataURL(i),o.onloadend=function(){e(o.result)}})})}const{FormRow:J,FormIcon:K}=m.Forms;function Q(t){let{guild:e,emojiNode:n}=t;const i=function(){x.showInputAlert({title:"Emoji name",initialValue:n.alt,placeholder:"bleh",onConfirm:function(c){N(n.src,function(s){D.uploadEmoji({guildId:e.id,image:s,name:c,roles:void 0}).then(function(){g.showToast(`Added ${n.alt} ${n.alt!==c?`as ${c} `:""}to ${e.name}`,p.getAssetIDByName("Check"))}).catch(function(l){g.showToast(l.body.message,p.getAssetIDByName("Small"))})})},confirmText:`Add to ${e.name}`,confirmColor:void 0,cancelText:"Cancel"}),d.hideActionSheet()},o=r.React.useMemo(function(){const c=e.getMaxEmojiSlots(),s=z.getGuilds()[e.id]?.emojis??[],l=n.src.includes(".gif");return s.filter(function(u){return u?.animated===l}).length<c},[]);return r.React.createElement(J,{leading:r.React.createElement(O,{guild:e,size:H.MEDIUM,animate:!1}),disabled:!o,label:e.name,subLabel:o?void 0:"No slots available",trailing:r.React.createElement(K,{style:{opacity:1},source:p.getAssetIDByName("ic_add_24px")}),onPress:i})}const{FormDivider:W,FormIcon:Y}=m.Forms;function Z(t){const e=React.createElement(I,{scrollable:!0},React.createElement(m.ErrorBoundary,null,React.createElement(ee,{emojiNode:t})));d.openLazy(Promise.resolve({default:function(){return e}}),"AddToServerActionSheet")}function ee(t){let{emojiNode:e}=t;const n=Object.values(k.getGuilds()).filter(function(i){return U.can(r.constants.Permissions.MANAGE_GUILD_EXPRESSIONS,i)});return React.createElement(React.Fragment,null,React.createElement(F,{title:`Stealing ${e.alt}`,leading:React.createElement(Y,{style:{marginRight:12,opacity:1},source:{uri:e.src},disableColor:!0}),trailing:React.createElement(_,{onPress:function(){return d.hideActionSheet()}})}),React.createElement(G,{style:{flex:1},contentContainerStyle:{paddingBottom:24},data:n,renderItem:function(i){let{item:o}=i;return React.createElement(Q,{guild:o,emojiNode:e})},ItemSeparatorComponent:W,keyExtractor:function(i){return i.id}}))}const{Button:y}=a.findByProps("TableRow","Button");function te(t){let{emojiNode:e}=t;const n=[{text:"Add to Server",callback:function(){return Z(e)}},{text:"Copy URL to clipboard",callback:function(){r.clipboard.setString(e.src),d.hideActionSheet(),g.showToast(`Copied ${e.alt}'s URL to clipboard`,p.getAssetIDByName("ic_copy_message_link"))}},...r.ReactNative.Platform.select({ios:[{text:"Copy image to clipboard",callback:function(){return N(e.src,function(i){r.clipboard.setImage(i.split(",")[1]),d.hideActionSheet(),g.showToast(`Copied ${e.alt}'s image to clipboard`,p.getAssetIDByName("ic_message_copy"))})}}],default:[]}),{text:`Save image to ${r.ReactNative.Platform.select({android:"Downloads",default:"Camera Roll"})}`,callback:function(){V(e.src,e.src.includes(".gif")?1:0),d.hideActionSheet(),g.showToast(`Saved ${e.alt}'s image to ${r.ReactNative.Platform.select({android:"Downloads",default:"Camera Roll"})}`,p.getAssetIDByName("toast_image_saved"))}}];return React.createElement(React.Fragment,null,n.map(function(i){let{text:o,callback:c}=i;return React.createElement(y,{color:y.Colors?.BRAND,text:o,size:y.Sizes?.SMALL,onPress:c,style:{marginTop:r.ReactNative.Platform.select({android:12,default:16})}})}))}const{TouchableOpacity:ne}=m.General,w=a.findByProps("GuildDetails");function ie(){if(w)return j("default",w);const t=[],e=h.before("openLazy",d,function(n){let[i,o]=n;o==="MessageEmojiActionSheet"&&(e(),i.then(function(c){t.push(h.after("default",c,function(s,l){t.push(j("type",l,!0))}))}))});return function(){return e(),t.forEach(function(n){return n?.()})}}function j(t,e){let n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!1;const i=h.after(t,e,function(o,c){let[{emojiNode:s}]=o;if(r.React.useEffect(function(){return function(){return void(n&&i())}},[]),!s.src)return;const l=c?.props?.children?.props?.children;if(!l)return;const u=h.after("type",l,function(M,A){r.React.useEffect(function(){return u},[]),console.log(A);const $=function(f){return f?.props?.source?.uri},E=P.findInReactTree(A,function(f){return f?.find?.($)}),v=E.findIndex($);v>=0&&(E[v]=r.React.createElement(ne,{onPress:function(){return q(s.src.split("?")[0])}},E[v]));const T=function(f){return f?.type?.name==="Button"},b=P.findInReactTree(A,function(f){return f?.find?.(T)}),B=b.findLastIndex(T);B>=0&&(b[B],b.splice(B+1,0,r.React.createElement(te,{emojiNode:s})))})});return i}function oe(t){let e;return function(){return e??=t()}}const re=oe(function(){const{MessagesHandlers:t}=a.findByProps("MessagesHandlers"),e=new t(function(){});return e.isModalOrActionsheetObstructing=function(){return d.hideActionSheet()},function(n){return e.handleTapEmoji({nativeEvent:{node:n}})}});function ae(t){let{id:e,name:n,animated:i}=t;try{re()(e?{id:e,alt:n,src:`https://cdn.discordapp.com/emojis/${e}.${i?"gif":"webp"}?size=128`}:{content:L.convertSurrogateToName(n),surrogate:n})}catch(o){console.log("Failed to open action sheet",o)}}const{TouchableOpacity:ce}=m.General;function se(){return h.before("render",I,function(t){let[e]=t;if(!e?.header?.props?.reactions||e.children.type?.name!=="FastList")return;const n=h.after("type",e.header,function(i,o){r.React.useEffect(function(){return n},[]);try{const c=o.props.children[0],{tabs:s,onSelect:l}=c.props;c.props.tabs=s.map(function(u){return r.React.createElement(ce,{onPress:function(){return l(u.props.index)},onLongPress:function(){const{emoji:M}=u.props.reaction;ae(M)}},u)})}catch{console.error("Failed to patch reaction header.")}})})}let R=[];var le={onLoad:function(){R.push(ie()),R.push(se())},onUnload:function(){for(const t of R)t()}};return S.default=le,Object.defineProperty(S,"__esModule",{value:!0}),S})({},vendetta.metro.common,vendetta.patcher,vendetta.ui.components,vendetta.metro,vendetta.ui.assets,vendetta.ui.toasts,vendetta.ui.alerts,vendetta.utils);
